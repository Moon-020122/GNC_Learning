# 基础知识

## 旋转矩阵是干什么的？

想象你在桌子上放了一张画着 $x$ 轴和 $y$ 轴的纸，手里拿着一根笔（向量）。

**旋转矩阵的作用**就是：你把这根笔围绕原点转动一个角度 $\theta$。

在数学上，我们用一个矩阵 $R$ 来乘以向量 $\vec{v}$，得到一个新的向量 $\vec{v}'$。
$$
\vec{v}' = R \vec{v}
$$
这个 $R$ 就是旋转矩阵。

$R_b^n$：把 **机体系向量** 变到 **导航系**

------

## 物理直觉——旋转有什么特点？

要理解为什么它是“正交”的，我们先闭上眼睛想一下，当你旋转一个物体时，发生了什么，没发生什么？

这里有两个**绝对不能变**的物理事实：

1. 长度不变（保长）：你把手机转了90度，手机变长了吗？变短了吗？当然没有。
   - *结论：旋转必须保持向量的长度（模长）为 1 的仍为 1。*
2. 夹角不变（保角）：想象你的 $x$ 轴和 $y$ 轴，它们本来是垂直的（90度）。当你把整个坐标系旋转后，新的 $x$ 轴和新的 $y$ 轴还在吗？还在。它们还是垂直的吗？当然还是垂直的。
   - *结论：旋转不能破坏坐标轴之间的垂直关系。*

- $R_b^n$ 的 **每一列**，是 **机体系的轴**在 **导航系**里的表示。

比如：
$$
R_b^n = \begin{bmatrix} | & | & | \\ \hat{x}_b^n & \hat{y}_b^n & \hat{z}_b^n \\ | & | & | \end{bmatrix}
$$

- 第一列：机体系 $x_b$ 轴在 NED 里指向哪里
- 第二列：机体系 $y_b$ 轴在 NED 里指向哪里
- 第三列：机体系 $z_b$ 轴在 NED 里指向哪里

------

## 为什么这叫“正交”？

在数学里，**正交矩阵**的定义正是基于上面那两个物理直觉的。如果一个矩阵 $R$ 是正交矩阵，它的列向量（Columns）必须满足两个条件：

1. **单位化**：每一列的长度都是 1。（对应上面的“长度不变”）
2. **正交**：列与列之间互相垂直，点积为 0。（对应上面的“夹角不变”）

让我们来看看 2D 旋转矩阵的样子
$$
R = \begin{bmatrix} \cos\theta & -\sin\theta \\ \sin\theta & \cos\theta \end{bmatrix}
$$
这个矩阵的第一列 $\vec{c_1} = \begin{bmatrix} \cos\theta \\ \sin\theta \end{bmatrix}$ 其实代表了旋转后的 X 轴。

这个矩阵的第二列 $\vec{c_2} = \begin{bmatrix} -\sin\theta \\ \cos\theta \end{bmatrix}$ 其实代表了旋转后的 Y 轴。

> 因为旋转不拉伸（长度为1）且不剪切（互相垂直），所以描述它的矩阵必须是由互相垂直的单位向量组成的。这就是正交矩阵的定义。

------

## 正交矩阵的“超能力”

正交矩阵有一个非常极其好用的性质，也是我们在工程和物理中爱死它的原因：
$$
R^T = R^{-1}
$$
**意思是：它的转置矩阵，就是它的逆矩阵。**

**物理意义是什么？**

- **逆矩阵 ($R^{-1}$)** 的意思是“撤销操作”。如果你顺时针转了 30 度，逆操作就是逆时针转 30 度（转回来）。
- **转置矩阵 ($R^T$)** 仅仅是把矩阵的行和列互换一下。

对于一般的矩阵，求逆矩阵是非常麻烦的计算。但对于旋转矩阵（正交矩阵），你想把物体转回去？**不需要重新计算，只需要把矩阵“翻转”一下（转置）就可以了！**

## 一个“永不出错”的自检：悬停条件

假设飞行器水平、机体轴和 NED 对齐（最简单情况）：

- $R_b^n = I$（单位矩阵）
- 忽略空气阻力等
- 悬停：加速度为 0

动力学（只看力）：
$$
\mathbf{a}^n = \mathbf{T}^n + m\mathbf{g}^n
$$
悬停 $\mathbf{a}^n=0$：
$$
0=\mathbf{T}^n + m\mathbf{g}^n
$$
又因为 $R=I$，$\mathbf{T}^n = \mathbf{T}^b=[0,0,-T]$，$\mathbf{g}^n=[0,0,g]$：
$$
0 = \begin{bmatrix}0\\0\\-T\end{bmatrix} + \begin{bmatrix}0\\0\\mg\end{bmatrix} \Rightarrow T = mg
$$
得到你直觉上“悬停推力=重量”。**如果你推导出来变成 $T=−mg$或者 $T=0$，那一定是符号/坐标系用错了。**

# 旋转描述

## 欧拉角与旋转矩阵

在航空常用定义（配合你用的 NED/Body 都是 Down 为正）：

- $\phi$roll（横滚）：绕 **机体$ x_b$**（前向轴）转
- $\theta$ pitch（俯仰）：绕 **机体 $y$**（右向轴）转（严格说是中间轴）
- $\psi$ yaw（偏航）：绕 **导航系 $z_n$**（向下轴）转（严格说是最外层轴）

它们的物理直觉：

- roll：机翼左右倾斜
- pitch：机头抬/低
- yaw：机头朝向北/东的转动（在水平面转）

你写的常用顺序是：**ZYX：yaw → pitch → roll**。

工程上常见的一种明确约定是：
$$
{R_b^n = R_z(\psi)\,R_y(\theta)\,R_x(\phi)}
$$

> 先处理 roll，再 pitch，再 yaw（注意矩阵乘法右边先作用）
>  但从“旋转序列”的口语描述上，大家常说 yaw→pitch→roll（这就是很多人混乱的来源）。

### 三个基本旋转矩阵

绕 x / y / z 轴旋转的 DCM（右手系,**方向余弦矩阵**）(**物理含义**：**坐标系不动，点在动。**是body到NED坐标系)：c

![image-20260112123452078](E:\DockerDesktopWSL\GNC_Learning\02_UAV\note\image\image-20260112123452078.png)

- 绕 x 轴旋转 \($\phi$\) 角的 DCM（旋转矩阵）：
  $$
  (\boldsymbol{C}_x(\phi)= \begin{bmatrix} 1 & 0 & 0 \\ 0 & \cos\phi & -\sin\phi \\ 0 & \sin\phi & \cos\phi \end{bmatrix})
  $$
  
- 绕 y 轴旋转 \($\theta$\) 角的 DCM：
  $$
  (\boldsymbol{C}_y(\theta)= \begin{bmatrix} \cos\theta & 0 & \sin\theta \\ 0 & 1 & 0 \\ -\sin\theta & 0 & \cos\theta \end{bmatrix})
  $$
  
  
  
- 绕 z 轴旋转 \($\psi$\) 角的 DCM：
  $$
  (\boldsymbol{C}_z(\psi)= \begin{bmatrix} \cos\psi & -\sin\psi & 0 \\ \sin\psi & \cos\psi & 0 \\ 0 & 0 & 1 \end{bmatrix})
  $$

把$ R_z(\psi)R_y(\theta)R_x(\phi)$乘开，会得到经典的 3×3 元素表达式：
$$
R_b^n = \begin{bmatrix} c_\psi c_\theta & c_\psi s_\theta s_\phi - s_\psi c_\phi & c_\psi s_\theta c_\phi + s_\psi s_\phi\\ s_\psi c_\theta & s_\psi s_\theta s_\phi + c_\psi c_\phi & s_\psi s_\theta c_\phi - c_\psi s_\phi\\ -s_\theta & c_\theta s_\phi & c_\theta c_\phi \end{bmatrix}
$$

### 欧拉角的硬伤：万向节锁

当 $\theta = \pm 90^\circ$∘（pitch 接近 ±90°）时，欧拉角会出现奇异性：yaw/roll 会纠缠，数值会炸。

![image-20260111154212609](E:\DockerDesktopWSL\GNC_Learning\02_UAV\note\image\image-20260111154212609.png)

## 四元数

四元数常写作（标量在前）：
$$
q = \begin{bmatrix} q_0\\q_1\\q_2\\q_3 \end{bmatrix} = \begin{bmatrix} w\\x\\y\\z \end{bmatrix}
$$
它代表一个旋转（可以想成“轴-角”的压缩表示,工程上）：
$$
q = q_z(\text{yaw}) \otimes q_y(\text{pitch}) \otimes q_x(\text{roll})
$$

- **$q$**：最终的成品四元数，代表了飞机当前的姿态（比如：头朝北，抬头30度，右歪10度）。

- **$q_z, q_y, q_x$**：三个零件四元数。

  - $q_z(\text{yaw})$：只做一个偏航动作（绕 Z 轴转）的四元数。
  - $q_y(\text{pitch})$：只做一个俯仰动作（绕 Y 轴转）的四元数。
  - $q_x(\text{roll})$：只做一个滚转动作（绕 X 轴转）的四元数。

- **$\otimes$**：四元数乘法。四元数的灵魂在于三个虚部单位 $i, j, k$。它们的乘法规则刻在石碑上，四元数乘法**不满足交换律**！$a \times b \neq b \times a$。这就解释了为什么旋转顺序（ZYX）不能乱。叫做 **Hamilton 规则**：
  $$
  i^2 = j^2 = k^2 = ijk = -1
  $$
  $q_{new} = q_1 \otimes q_2$ 的结果是：

  - 新的实部 ($w$)：实乘实 - 虚点乘虚
    $$
    w_{new} = w_1 w_2 - \mathbf{v}_1 \cdot \mathbf{v}_2
    $$

  - 新的虚部 ($\mathbf{v}$)：实乘虚 + 虚乘实 + 虚叉乘虚
    $$
    \mathbf{v}_{new} = w_1 \mathbf{v}_2 + w_2 \mathbf{v}_1 + \mathbf{v}_1 \times \mathbf{v}_2
    $$

- 旋转轴单位向量 $\hat{u}$
- 旋转角 $α$

对应(理论上)，可以计算出上述的绕单个轴旋转的角度然后构造出工程上的代码：
$$
q_0=\cos(\alpha/2),\quad \begin{bmatrix}q_1\\q_2\\q_3\end{bmatrix} =\hat{u}\,\sin(\alpha/2)
$$
**$w$ (实部/标量)**：主要存储了**“转了多少角度”**的信息（$\cos(\alpha/2)$）。

**$x, y, z$ (虚部/向量)**：混合了**“转轴指向哪里”**和**“转了多少”**的信息（因为乘了 $\sin(\alpha/2)$）。

$q$ 和 $-q$ 表示同一个姿态

- 如果 $q = [1, 0, 0, 0]$ 代表“原始位置”。

  那么 $q = [-1, 0, 0, 0]$ 也代表“原始位置”。

  就像你原地转 360 度 ($+360^\circ$) 和原地反转 360 度 ($-360^\circ$)，人最后站的方向是一样的。

- **GNC 场景**：你的传感器（比如磁力计）解算出来的四元数可能会在 $q$ 和 $-q$ 之间跳变。

- **代码处理**：在做控制算法（比如计算误差）时，要检查两个四元数的点积。如果点积是负数，说明它俩“反号”了，要把其中一个的所有元素乘以 -1，把它们“掰正”，否则飞机会突然想翻个跟头。

 $\|q\|=1$ （归一化）

- $$
  \sqrt{w^2 + x^2 + y^2 + z^2} = 1
  $$

  只有长度为 1 的四元数，才纯粹代表**“旋转”。如果长度不是 1（比如 0.9 或 1.2），它不仅会旋转物体，还会把物体缩小或放大**。

- GNC 场景：计算机做浮点数运算会有误差（0.9999...）。经过成千上万次积分后，四元数的长度会慢慢偏离 1。

### 四元数与旋转矩阵

若 $q=[w,x,y,z]^T$，一种常用的$R_b^n(q)$形式是：
$$
R_b^n(q)= \begin{bmatrix} 1-2(y^2+z^2) & 2(xy-wz) & 2(xz+wy)\\ 2(xy+wz) & 1-2(x^2+z^2) & 2(yz-wx)\\ 2(xz-wy) & 2(yz+wx) & 1-2(x^2+y^2) \end{bmatrix}
$$

> 注意：不同书/库可能用 $q=[x,y,z,w]$（标量在后），那公式会变。
> 你要做的是：**固定一种约定贯穿整个工程**。

1. 为什么要转换？

- 四元数虽好，但它**不能直接乘向量**。
- 你想知道：“机头前方的刺针（机体坐标 $[1,0,0]$），现在在地图上指向哪里？”
- 四元数无法直接告诉你，你必须把它变成旋转矩阵 $R$，然后用 $v_{new} = R \cdot v_{old}$ 来计算。

2. 最大的坑：顺序问题

 q=[w,x,y,z]（标量在前）是 Hamilton 约定。很多开源库使用的是 q=[x,y,z,w]（标量在后）。

- **后果**：如果你把 $x$ 当成了 $w$ 代入那个大矩阵公式，飞机就会在天上乱飞。
- **GNC 工程师职责**：拿到任何一段代码或公式，**第一件事先看它的 $w$ 在哪**。

### 姿态动力学

####  $\omega$ (角速度)

**符号含义**：

- **$\omega$ (Omega)**：角速度向量。
- **$b$ (Body)**：代表“机体坐标系”。
- **$[p, q, r]^T$**：分别对应绕机身 X、Y、Z 轴旋转的快慢。单位通常是 **弧度/秒 (rad/s)**。

它来自无人机/手机里那个几美元的芯片 —— 陀螺仪 (Gyroscope)。

- 陀螺仪是瞎子，它不知道天在哪，也不知道北在哪。
- 它只知道：**“我现在转得有多快”。**

工程直觉：想象你闭着眼睛坐在转椅上。

- 你不知道你面朝南方还是北方（姿态未知）。
- 但如果有人推你一把，你能感觉到“我在顺时针快速旋转”（角速度已知）。
- 这个方程的任务就是：**根据你感觉得到的“旋转快慢”，推算出你脑海里的“当前朝向”。**

#### 刚体运动学微分方程 $\dot{q} = \frac{1}{2}\Omega(\omega) q$

1. 定义导数：
   $$
   \dot{q} \approx \frac{q(t+\Delta t) - q(t)}{\Delta t}
   $$
   也就是说：$q(t+\Delta t) \approx q(t) + \dot{q} \Delta t$

2. 物理过程：

   下一时刻的姿态 = 当前姿态 $\otimes$ 一个微小的旋转。
   $$
   q(t+\Delta t) = q(t) \otimes \Delta q
   $$

3. 微小旋转长什么样？

   如果时间 $\Delta t$ 很短，转过的角度 $\Delta \theta$ 很小。还记得四元数定义吗？$q = [\cos(\frac{\theta}{2}), \vec{u}\sin(\frac{\theta}{2})]$。

   当角度很小时：

   - $\cos(\text{小}) \approx 1$

   - $\sin(\text{小}) \approx \text{小}$

     也就是：$\Delta q \approx [1, \frac{\Delta \theta}{2} \vec{u}] = [1, \frac{\omega \Delta t}{2}]$ （因为 角度 = 角速度 $\times$ 时间）。

4. 代回去：
   $$
   q(t) + \dot{q} \Delta t \approx q(t) \otimes [1, \frac{\omega \Delta t}{2}]
   $$
   展开右边：
   $$
   q(t) + q(t) \otimes \frac{\omega}{2} \Delta t
   $$

5. 消项：左边的 $q(t)$ 和右边的 $q(t)$ 抵消。两边同时除以 $\Delta t$。得到：
   $$
   \dot{q} = q(t) \otimes \frac{\omega}{2} = \frac{1}{2} q \otimes \omega
   $$

这就是那个 $\frac{1}{2}$ 的真正来源（因为小角度近似时是 $\theta/2$），也是微分方程的来源。

#### 1. $\dot{q}$ (q-dot) 是什么？

数学上叫“四元数的对时间导数”。

- **$q$**：当前的姿态（比如：我现在头朝北）。
- **$\dot{q}$**：姿态的变化率（比如：我的头正在往东偏）。
- **注意**：$\dot{q}$ **不等于** 角速度 $\omega$。角速度是物理里的转动快慢，而 $\dot{q}$ 是四元数那 4 个数字 $(w,x,y,z)$ 变化的快慢。

#### 2. 为什么要乘以 $\frac{1}{2}$？

- 推导来源（了解即可）：还记得四元数定义里有 $\cos(\alpha/2)$ 和 $\sin(\alpha/2)$ 吗？

  当你对角度 $\alpha$ 求导时，根据链式法则，$(\alpha/2)' = 1/2 \cdot \alpha'$。那个 $\frac{1}{2}$ 就是因为四元数用的是半角而带出来的。

#### 3. 那个大矩阵 $\Omega(\omega)$ 是什么？

四元数的乘法原本是：$q_{new} = q_{old} \otimes q_{\omega}$。但是四元数乘法写成代码很麻烦（一堆叉乘和点乘）。

我们要明确一个数学事实：**四元数的乘法是线性的**。假设有两个四元数：

- 姿态 $q = [w, x, y, z]^T$
- 角速度四元数 $\omega' = [0, p, q, r]^T$ （角速度是纯向量，实部为0）

按照四元数的乘法规则（$q_{new} = q \otimes \omega'$），如果我们老老实实地展开每一项，会得到一个新的四元数，其 4 个元素分别是：

1. **实部**：$-px - qy - rz$  (这是四元数乘法规则里的 $- \vec{v}_1 \cdot \vec{v}_2$)
2. **i部**：$pw + ry - qz$
3. **j部**：$qw - rx + pz$
4. **k部**：$rw + qx - py$

工程师觉得这样写公式太乱了！ 看着眼花。于是，大家想把这个运算写成矩阵乘法的形式：$y = A \cdot x$。

我们就把上面的结果“强行”拆开，把 $w,x,y,z$ 提出来放在右边，剩下的系数写在左边的大矩阵里：
$$
\begin{bmatrix} \dot{w} \\ \dot{x} \\ \dot{y} \\ \dot{z} \end{bmatrix} = \frac{1}{2} \underbrace{ \begin{bmatrix} 0 & -p & -q & -r \\ p & 0 & r & -q \\ q & -r & 0 & p \\ r & q & -p & 0 \end{bmatrix} }_{\Omega(\omega)} \begin{bmatrix} w \\ x \\ y \\ z \end{bmatrix}
$$

结论：$\Omega(\omega)$ 不是什么神奇的新物理量。它只是把“四元数乘法”这个复杂的代数过程，整理成了一个整洁的“矩阵乘向量”的表格。它完全由 $(p, q, r)$ 填充而成。