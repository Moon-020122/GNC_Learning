# 电机模型与Mixer

多旋翼（四旋翼）里最核心的一步：

> **把“我想让飞机产生的总推力 + 3轴力矩”
>  变成“4 个电机应该转多快”**

这一步就是 **Mixer（混控/分配矩阵）**。而 Mixer 之所以能写成一个矩阵乘法，是因为我们用了一个工程近似：
$$
T_i = k_T \omega_i^2,\quad Q_i = k_Q \omega_i^2
$$
于是“总推力、力矩”就变成对 $\omega_i^2$ 的**线性组合**。

------

## 1.1 为什么推力/反扭矩模型是 $\omega^2$？

- $\omega_i$：第 i 个电机/桨的角速度（rad/s）

  - 和常见的 RPM（转/分钟）关系：
    $$
    \omega = 2\pi \cdot \text{(rev/s)} = 2\pi \cdot \frac{\text{RPM}}{60}
    $$

- $T_i$：第 i 个桨产生的**推力大小**（N）

- $Q_i$：第 i 个桨对机体产生的**反扭矩大小**（N·m），**反扭矩（Counter-Torque）是牛顿第三定律（作用力与反作用力）的直接体现(角动量守恒)。**想象你站在冰面上（或者坐在旋转办公椅上），手里拿着一个很重的轮子。如果你用力让轮子**顺时针**转动。你的身体就会不由自主地**逆时针**转动。

  **在无人机上是完全一样的道理：**

  1. **动作（Action）：** 电机给螺旋桨施加力矩，强迫螺旋桨切割空气旋转（假设是顺时针）。
  2. **阻力（Drag）：** 空气是有粘性和阻力的，它不想让螺旋桨转，所以空气会给螺旋桨一个反向的阻力矩。
  3. **反作用（Reaction）：** 为了克服这个空气阻力，电机必须持续用力。根据牛顿第三定律，螺旋桨反过来会给电机（以及连着的机架）施加一个**大小相等、方向相反**的力矩。

  - 这是“桨被空气阻力拖住”的那股扭矩
  - 电机要输出扭矩去克服它
  - 机体会受到反作用扭矩（导致 yaw）

- $k_T, k_Q$：把“空气密度、桨直径、桨形、效率、单位换算”等**全部打包进一个常数**（靠标定/实验/厂家数据）

**速度越快，空气作用力按“速度平方”涨**，螺旋桨叶片在转，叶片上的某个点的线速度大约是：
$$
v \approx \omega r
$$
空气对叶片产生的气动力（升力/阻力）非常典型地与“动压”相关：
$$
q = \frac{1}{2}\rho v^2
$$
所以力的尺度通常是：
$$
F \sim q \cdot S \sim \rho v^2 \cdot S \sim \rho (\omega r)^2 \cdot S
$$
**核心结论：**只要桨形不变、迎角不乱飞、工况不太离谱，气动力整体就会呈现
$$
T\propto \omega^2
$$
这就是“为什么是平方”的物理来源：**动压是速度平方**。

---

**工程上更标准的一套公式**

螺旋桨常用无量纲系数写法（非常常见）：
$$
T = C_T \rho n^2 D^4,\quad Q = C_Q \rho n^2 D^5
$$

- $n$：转速（rev/s）
- $D$：桨直径
- $C_T, C_Q$：推力/扭矩系数（与桨、来流、Re数等有关）

因为 $n \propto \omega$，所以依旧是：
$$
T \propto \omega^2,\quad Q \propto \omega^2
$$
于是工程上就把它写成你现在用的：
$$
T_i = k_T \omega_i^2,\quad Q_i = k_Q \omega_i^2
$$

---

**够用（大多数 GNC 入门/控制设计/仿真）：**

- 悬停附近
- 中低速飞行
- 螺旋桨不接近失速/强烈非定常

**不够用（空气动力学/更高精度才需要）：**

- 强前飞（有明显来流、桨盘迎风）
- 大攻角机动、桨叶局部失速
- 很高转速接近压缩性效应
- 严格功率、效率建模

> 你作为 GNC 工程师：
>  **必须知道这个模型的“适用范围 + 怎么标定/怎么兜底”。**
>  不需要从桨叶气动细节推到 CFD（那是旋翼/空气动力方向）。

------

## 1.2 Mixer 的本质

把 “4个 $\omega_i^2$” 线性组合成 “总推力 + 3轴力矩”

---

**先定义你要控制的“目标量”**
$$
u= \begin{bmatrix} T\\ \tau_x\\ \tau_y\\ \tau_z \end{bmatrix}
$$

- $T$：机体期望的**总推力**（沿机体 z 轴方向）
- $\tau_x$：绕机体 x 轴的力矩（roll）
- $\tau_y$：绕机体 y 轴的力矩（pitch）
- $\tau_z$：绕机体 z 轴的力矩（yaw）

$$
w^2= \begin{bmatrix} \omega_1^2\\ \omega_2^2\\ \omega_3^2\\ \omega_4^2 \end{bmatrix}
$$

为什么用$ \omega^2$ 而不是 $\omega$？因为 $T_i,Q_i$ 都正比 $\omega_i^2$，这样写出来才是**线性的矩阵乘法**。

------

**每个电机到底对机体做了什么？**

在你的坐标（Body：x前、y右、z下）下：

- 单个电机产生的推力方向是“向上”（对抗重力）但因为你 z 轴定义为“向下”，所以推力在 z 方向是负号：
  $$
  F_i^b = \begin{bmatrix} 0\\ 0\\ -T_i \end{bmatrix}
  $$

- 电机在机体上的位置（臂长/布局）：

$$
r_i^b = \begin{bmatrix} x_i\\ y_i\\ 0 \end{bmatrix}
$$

------

**推力如何产生 roll/pitch 力矩？**

力矩定义：
$$
\tau_i = r_i \times F_i
$$
把叉乘算一下：
$$
r\times F= \begin{bmatrix} -yT\\ xT\\ 0 \end{bmatrix}
$$
这句的含义非常直观：

- **roll 力矩 $\tau_x$** 来自$ -y_i T_i$
  - 电机在机体右侧（$y>0$）推力向上，会让机体产生某个方向的滚转力矩
- **pitch 力矩 $\tau_y$** 来自 $+x_i T_i$
  - 电机在机体前方（$x>0$）推力向上，会产生俯仰力矩

------

**yaw 力矩从哪来？（反扭矩）**

除了“推力造成的力矩”，还有“电机被空气阻力拖住”的反扭矩：
$$
\tau_{z,i} = s_i Q_i = s_i k_Q \omega_i^2
$$

- $s_i=\pm1$：表示该电机旋向（CW/CCW）以及你规定的正负号
- 物理上：**桨转一个方向，机体会被反作用扭到另一个方向**

------

**把所有电机加起来，就是矩阵 A 的四行**

总推力：
$$
T = \sum_i T_i = \sum_i k_T \omega_i^2
$$
roll：
$$
\tau_x=\sum_i (-y_i T_i)=\sum_i (-y_i k_T \omega_i^2)
$$
pitch：
$$
\tau_y=\sum_i (x_i T_i)=\sum_i (x_i k_T \omega_i^2)
$$
yaw：
$$
\tau_z=\sum_i (s_i k_Q \omega_i^2)
$$
合起来就是：
$$
u = A w^2
$$
其中
$$
A= \begin{bmatrix} k_T & k_T & k_T & k_T\\ -k_Ty_1 & -k_Ty_2 & -k_Ty_3 & -k_Ty_4\\ k_Tx_1 & k_Tx_2 & k_Tx_3 & k_Tx_4\\ k_Qs_1 & k_Qs_2 & k_Qs_3 & k_Qs_4 \end{bmatrix}
$$

------

**真正用的时候：你要从 $u$ 反求 $\omega_i$**，控制器给你 $u$，你要算电机转速：
$$
w^2 = A^{-1}u \quad (\text{或伪逆 }A^\dagger) \\
\omega_i = \sqrt{\max(w_i^2, 0)}
$$
工程上必须处理：

- $\omega_i^2$ 不能为负（负了说明命令超出可实现范围）
- 转速有上限（饱和）
- 饱和会让“实际输出的 $u$”偏离“期望 $u$”（这会影响控制稳定性，需要 anti-windup / 约束分配）

> “矩阵可逆性严格证明”这类可以不深究到数学家级别。
>  你只要会：**X/十字构型合理编号时可逆；不可逆或过驱动就用伪逆/约束分配。**

## 1.3 “求逆/伪逆 + 饱和”的工程要点

你有一个**想要的机体输出**：
$$
u= \begin{bmatrix} T\\ \tau_x\\ \tau_y\\ \tau_z \end{bmatrix}
$$
你也有一个**电机侧的变量**（为了线性）：
$$
w^2= \begin{bmatrix} \omega_1^2\\ \omega_2^2\\ \omega_3^2\\ \omega_4^2 \end{bmatrix}
$$
两者关系是：
$$
u = A w^2
$$
**Mixer 做的事：**给我想要的 $u$，我算出电机该给的 $w^2$，再开方得到 $\omega$。

------

**什么时候能直接用 $A^{-1}$？**

如果：

- 你有 4 个电机
- 你想控制 4 个量（$T,\tau_x,\tau_y,\tau_z$）
- 你的构型让 $A$ **可逆**（行列式不为 0）

那就可以：
$$
w^2 = A^{-1} u
$$
**物理含义：**

- 你让系统输出四个目标量
- 4 个电机正好提供 4 个自由度
- 所以可以“一一对应解出来”

> 你不需要做“严格可逆性证明”。工程上你要会的是：
>  **X 构型/十字构型合理编号通常可逆；不合理布局/参数错误可能不可逆。**

------

 **“伪逆 $A^+$”是干嘛的？（工程上非常常用）**

- 电机不止 4 个（六旋翼、八旋翼）→ **变量比目标多**
- 少一个电机还能不能飞（容错）→ **变量比目标少**
- 你想加约束/优先级（先保姿态再保 yaw）→ **不是单纯求逆能搞定**

这时你用伪逆：
$$
w^2 = A^{+} u
$$
伪逆在很多工程场景下等价于在解这个问题：

> 在所有能让 $Aw^2$ 尽量接近 $u$ 的解里，
>  选一个“最合理”的（通常是能量/转速变化最小的）解。

最常见的理解是“最小二乘”：
$$
w^2 = \arg\min_{w^2}\ \|Aw^2-u\|^2
$$

- 如果完全能实现（有精确解），它就给你一个解
- 如果不能完全实现，它给你“误差最小”的那个

> 伪逆的严格数学性质证明（Moore–Penrose 条件）你不必背。
>  你必须会的是：**它在工程上就是“最小二乘最合适解”。**

------

**现实世界的硬约束：为什么必须“限幅 + 非负”？**

电机转速有物理限制：

**不能倒着转（通常）**
$$
\omega_i \ge 0 \Rightarrow \omega_i^2 \ge 0
$$
**最大转速有限**
$$
\omega_i \le \omega_{\max} \Rightarrow \omega_i^2 \le \omega_{\max}^2
$$
**有时还会有最小转速**
$$
\omega_i \ge \omega_{\min} \Rightarrow \omega_i^2 \ge \omega_{\min}^2
$$
（比如防止电机停转、保持可控性、或 ESC 的最小油门）

所以你要做的就是对每个 $w_i^2$ 做“夹逼（clamp）”：
$$
w_{i,\text{sat}}^2 = \text{clip}\big(w_i^2,\ \omega_{\min}^2,\ \omega_{\max}^2\big)
$$
并且确保
$$
w_{i,\text{sat}}^2 \ge 0
$$
数学上： 控制器算出来你需要一个推力 $T = -5$ 牛顿。根据公式 $T = k \omega^2$，那么 $\omega^2 = -5/k$。

现实中： 你的电机和电调（ESC）通常只能单向旋转。

- 大部分无人机螺旋桨只能产生**向上**的推力（正推力）。
- 它不能产生**向下**的拉力（负推力），除非你用那种昂贵的变距螺旋桨或特殊的3D特技电调。

这意味着什么？如果 PID 算出“现在必须给这个电机负的力才能平衡”，代码里如果不加 max(0) 检查，试图对负数开根号 ($\sqrt{-5}$)，程序直接崩溃（NaN错误），飞机坠毁。

解决办法： 也就是你看到的 $max(w^2, 0)$，意思是：“如果算出需要负推力，我就当做是 0（停转），因为我真的做不到负的。”

------

**饱和会导致一个事实：你想要的 $u$ 可能实现不了**

你先算出来的$ w^2$ 是“数学上为了实现 $u$”的解。

但你一夹逼（限幅）：

- 有的电机到顶了
- 有的电机被抬到最低了
- 有的被截成 0

这时真正执行的是 $w^2_{\text{sat}}$，所以真实能产生的输出变成：
$$
u_{\text{ach}} = A w_{\text{sat}}^2
$$
这里：

- $u$：你“想要”的
- $u_{\text{ach}}$：你“实际上做到了”的

**这一步非常工程**：你必须接受“不可实现”是常态，不是异常。通过$u_{\text{ach}}$你能直接看到：

- 我是不是推力不够？
- 是不是 roll/pitch 打满了？
- 是不是 yaw 被牺牲了？

**饱和不仅仅是“力气不够大”，它会破坏“力的平衡”，导致飞机乱飞。**

假设你要向右翻滚（需要：左电机快，右电机慢）：

- **理想计算：** 左电机 110%，右电机 90%。差值是 20%（产生翻滚力矩）。
- **实际发生（饱和）：** 左电机卡在 100%，右电机依然是 90%。
- **后果：**
  1. **推力不够：** 总推力变小了（本来期望 200 total，现在只有 190），飞机可能会**掉高度**。
  2. **力矩不够：** 差值变成了 $100-90=10\%$。翻滚速度只有预期的一半，飞机反应迟钝。
  3. **最可怕的耦合（Coupling）：** 如果是四轴同时动作，某个轴饱和可能会导致其他轴的比例错乱，比如你只想翻滚，结果因为一个电机饱和了，导致偏航（Yaw）力矩也不平衡了，飞机**一边翻滚一边怪异地甩尾**。

约束分配（Control Allocation）的解决方法：算法会聪明地做取舍。比如：“既然左边到不了 110%，那为了保持翻滚的力矩差（20%），我把右边电机降低到 80% 吧！”

- 结果：左 100%，右 80%。差值依然是 20%（保住了翻滚姿态），虽然总推力降低了（保姿态，弃高度）。

---

**控制器抗饱和（anti-windup）**

尤其 PID 里有积分项：如果你一直“想要做但做不到”，积分会越积越大，解除饱和时就会一下子冲出去（典型炸机来源）。积分项的作用是“积累过去的误差”。

- **场景：** 飞机因为挂了重物，一直达不到目标高度。
- **过程：**
  1. PID 里的 **I** 项发现：“哎呀，一直有误差”，于是拼命累加，计算出的输出值从 100% 飙升到 1000%（虽然电机物理上卡在 100%）。
  2. **I** 项的“记忆”里存了一个巨大的数值（比如 10000）。
  3. 突然，你卸掉了重物。
- **灾难：** 虽然误差没了，但 **I** 项记忆里那个 10000 还在！它需要很长时间才能减下来。
- **结果：** 飞机会像火箭一样冲上天（过冲），直到 I 项慢慢减退。

工程常见做法之一是用“实现误差”做回算：

- 用$ u - u_{\text{ach}}$ 或者其某种等价形式，抑制积分增长
- 或者在饱和时冻结积分/限制积分

> anti-windup 的严格稳定性证明你不必做。
>  你必须会：**识别积分风up的现象 + 采取工程措施。**

------

**“优先级”的分配**

当饱和发生时，通常希望：

- **优先保 roll/pitch（保姿态）**
- 其次保总推力（别掉下来）
- 最后才是 yaw（yaw 可以牺牲一点）

这会引出“加权最小二乘 / 约束分配 / 分层分配”等方法。

------

## 1.4 电机动态：一阶滞后（$\tau_m$到底代表什么？）

模型：
$$
\dot\omega = \frac{\omega_{\text{cmd}} - \omega}{\tau_m}\\
\text{加速度} = \frac{\text{目标转速} - \text{当前转速}}{\text{时间常数}}
$$
**差距越大，加速越猛：** 当你刚开始启动（当前 0，目标 1000），差距巨大，加速度最大。

**越接近，越疲软：** 当你加速到 900 时，差距只有 100 了，加速度就变小了。当你到了 999，加速度几乎为 0。

它的速度曲线不是直线的，而是一个**“先快后慢”的弧线**

- $\omega$：电机“真实转速”
- $\omega_{\text{cmd}}$：你“命令它要到的转速”（来自 mixer 的输出）
- $\dot\omega$：转速变化率（每秒变化多少）
- $\tau_m$：**时间常数**（电机响应快慢的指标）

---

**$\tau_m$ 的物理意义**

如果你给一个阶跃命令（突然从 0 要到某个转速）：

- 过了 $1\tau_m $时间，电机大约到目标的 **63%**
- 过了 $3\tau_m$ 时间，大约到 **95%**
- 过了 $ 5\tau_m $时间，基本到 **99%**

这就是“一阶系统”的典型指数响应。

------

 **为什么推荐“指数精确离散化”？它从哪来？**

离散公式：
$$
\omega_{k+1}= \omega_{\text{cmd}} + (\omega_k-\omega_{\text{cmd}})\,e^{-dt/\tau_m}
$$
这是把连续 ODE 在“命令在 dt 内不变”假设下，做了**精确解**,“下一步的速度，等于 **目标速度** 加上 **剩下的误差**。” 关键是：剩下的误差 = **当前的误差 $\times$ 一个打折系数**。**$e^{-dt/\tau_m}$**（衰减系数）。

- 这是一个永远在 0 到 1 之间的数字。
- $(\omega_k - \omega_{cmd})$ 是当前的**误差（差距）**。

推导过程：
$$
\frac{d\omega}{dt} = \frac{\omega_{cmd} - \omega}{\tau}
$$
移项（把含 $\omega$ 的扔到左边，含 $dt$ 的扔到右边）：
$$
\frac{d\omega}{\omega_{cmd} - \omega} = \frac{1}{\tau} dt
$$
两边同时积分：左边积分得到 $-\ln(\omega_{cmd} - \omega)$，右边是 $t/\tau$。
$$
\ln(\omega_{cmd} - \omega) = -\frac{t}{\tau} + C
$$
去掉对数（两边取 $e$ 的指数）：
$$
\omega_{cmd} - \omega(t) = C' \cdot e^{-t/\tau}
$$
代入初值条件：这就是那个 $e^{-dt/\tau}$ 的来源！它证明了物理量的变化本质上就是指数衰减的。

------

**为什么不用欧拉法？欧拉法哪里容易炸？**

欧拉离散是：
$$
\omega_{k+1} = \omega_k + dt\cdot\frac{\omega_{\text{cmd}}-\omega_k}{\tau_m}
$$
它在 $dt$ 相对 $\tau_m$不够小的时候会：

- 响应过冲

  - 它假设在这一步 $dt$ 的时间内，**加速度是恒定不变的**。

    **致命缺陷（过冲）：**

    - 刚才说了，物理上越接近目标，加速度应该越小。
    - 但在欧拉法里，你用起步时的**最大加速度**，保持了整整 $dt$ 这么久。
    - 如果 $dt$ 很大（步子迈大了），你就会**直接冲过终点**。
    - 下一帧，发现冲过头了，又用巨大的反向加速度往回跑，结果**又冲过头了**。
    - **结果：** 就在目标附近疯狂震荡，甚至数值爆炸（炸机）。

- 甚至数值不稳定（仿真会“炸”）

而指数精确解：

- $dt$ 再大也不会数值发散（它是解析解）
- 更接近真实电机“指数逼近”的物理行为